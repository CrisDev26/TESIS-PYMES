<app-navbar></app-navbar>
<div class="dash">
  <app-sidebar class="dash__sidebar"></app-sidebar>
  <main class="dash__content">
    <header class="dash__header">
      <h1>Licitaciones Disponibles</h1>
      <p class="muted">Busca por palabra clave, categor√≠a y presupuesto. Mostrando datos reales de SERCOP Ecuador.</p>
    </header>

    <section class="filters">
      <div class="toolbar">
        <div class="tool tool--icon tool--grow">
          <i class="fas fa-magnifying-glass" aria-hidden="true"></i>
          <input type="text" [(ngModel)]="q" name="q" placeholder="Buscar por t√≠tulo, entidad o OCID" aria-label="B√∫squeda" />
          <button type="button" class="clear" *ngIf="q" (click)="clearQ()" aria-label="Limpiar b√∫squeda"><i class="fas fa-times"></i></button>
        </div>

        <div class="tool tool--icon" #catBox>
          <i class="fas fa-tags" aria-hidden="true"></i>
          <button type="button" class="dropdown__toggle" (click)="toggleCatMenu()" [attr.aria-expanded]="catOpen" aria-haspopup="listbox" aria-label="Categor√≠a">
            {{ category ? category : 'Todas las categor√≠as' }}
            <i class="fas fa-chevron-down dropdown__caret" aria-hidden="true"></i>
          </button>
          <div class="dropdown__menu" *ngIf="catOpen" role="listbox" aria-label="Lista de categor√≠as">
            <button type="button" class="dropdown__item" (click)="selectCategory('')" role="option" [attr.aria-selected]="!category">
              Todas las categor√≠as
            </button>
            <button type="button" class="dropdown__item" *ngFor="let c of categories" (click)="selectCategory(c)" role="option" [attr.aria-selected]="category===c">
              {{ c }}
            </button>
          </div>
        </div>

        <div class="tool tool--icon tool--narrow">
          <i class="fas fa-sack-dollar" aria-hidden="true"></i>
          <input type="number" [(ngModel)]="minBudget" name="minBudget" min="0" placeholder="M√≠n. presupuesto" aria-label="Presupuesto m√≠nimo" />
        </div>
        <div class="tool tool--icon tool--narrow">
          <i class="fas fa-sack-dollar" aria-hidden="true"></i>
          <input type="number" [(ngModel)]="maxBudget" name="maxBudget" min="0" placeholder="M√°x. presupuesto" aria-label="Presupuesto m√°ximo" />
        </div>

        <div class="pill-group">
          <button type="button" class="pill" [class.is-active]="showOpen" (click)="toggleStatus('open')">
            Abiertas <span class="count-mini">{{ openResults.length }}</span>
          </button>
          <button type="button" class="pill" [class.is-active]="showClosed" (click)="toggleStatus('closed')">
            Cerradas <span class="count-mini">{{ closedResults.length }}</span>
          </button>
        </div>

        <div class="spacer"></div>

        <button type="button" class="btn ghost" (click)="resetFilters()">Restablecer</button>
      </div>

      <div class="chips" *ngIf="hasActiveFilters()">
        <span class="chip" *ngIf="q">{{ q }} <button type="button" (click)="clearQ()" aria-label="Quitar"><i class="fas fa-times"></i></button></span>
        <span class="chip" *ngIf="category">{{ category }} <button type="button" (click)="clearCategory()" aria-label="Quitar"><i class="fas fa-times"></i></button></span>
        <span class="chip" *ngIf="minBudget != null">Min: {{ minBudget }} <button type="button" (click)="clearMin()" aria-label="Quitar"><i class="fas fa-times"></i></button></span>
        <span class="chip" *ngIf="maxBudget != null">Max: {{ maxBudget }} <button type="button" (click)="clearMax()" aria-label="Quitar"><i class="fas fa-times"></i></button></span>
      </div>
    </section>

    <!-- NUEVA SECCI√ìN: Recomendaciones del D√≠a -->
    <section class="daily-recommendations" *ngIf="!isLoadingRecommendations && dailyRecommendations?.has_recommendations">
      <div class="recommendations-header">
        <div class="header-left">
          <i class="fas fa-sparkles"></i>
          <div>
            <h2>Recomendaciones del D√≠a</h2>
            <p class="muted">Actualizadas cada 24 horas ‚Ä¢ Pr√≥xima actualizaci√≥n: {{ dailyRecommendations.next_update | date:'short' }}</p>
          </div>
        </div>
        <span class="ai-badge">
          <i class="fas fa-robot"></i>
          IA
        </span>
      </div>

      <!-- Resumen General -->
      <div class="summary-box">
        <i class="fas fa-lightbulb"></i>
        <p>{{ dailyRecommendations.summary }}</p>
      </div>

      <!-- Las 3 Licitaciones Recomendadas -->
      <div class="recommended-cards">
        <article class="card card--recommended" *ngFor="let tender of dailyRecommendations.tenders; let i = index">
          <div class="recommendation-badge">
            <i class="fas fa-star"></i>
            Top {{ i + 1 }}
          </div>

          <header class="card__header">
            <span class="badge badge--open">Abierta</span>
            <h3 class="card__title">{{ tender.title }}</h3>
          </header>

          <ul class="meta">
            <li><i class="fas fa-building"></i> {{ tender.buyer_name }}</li>
            <li><i class="fas fa-sack-dollar"></i> {{ formatMoney(tender.budget_amount) }}</li>
            <li><i class="fas fa-tags"></i> {{ tender.main_category }}</li>
            <li><i class="fas fa-users"></i> {{ tender.number_of_tenderers }} competidores</li>
            <li><i class="fas fa-calendar-check"></i> Cierra: {{ tender.tender_end_date | date:'mediumDate' }}</li>
          </ul>

          <footer class="card__footer">
            <button class="btn primary">Ver detalle</button>
            <button class="btn btn-ai" (click)="getAIRecommendation(tender)">
              <i class="fas fa-robot"></i> An√°lisis IA
            </button>
          </footer>
        </article>
      </div>
    </section>

    <!-- Loading de recomendaciones -->
    <section class="daily-recommendations loading" *ngIf="isLoadingRecommendations">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Cargando recomendaciones del d√≠a...</p>
    </section>

    <!-- Sin recomendaciones -->
    <section class="daily-recommendations empty" *ngIf="!isLoadingRecommendations && dailyRecommendations && !dailyRecommendations.has_recommendations">
      <i class="fas fa-inbox"></i>
      <p>{{ dailyRecommendations.message || 'No hay recomendaciones disponibles en este momento' }}</p>
    </section>

    <section class="results">
      <div class="results__group">
        <h2>Abiertas <span class="count">{{ openResults.length }}</span></h2>
        <div class="cards" *ngIf="openResults.length; else emptyOpen">
          <article class="card card--open" *ngFor="let t of openResults">
            <header class="card__header">
              <span class="badge badge--open">Abierta</span>
              <h3 class="card__title">{{ t.title }}</h3>
            </header>
            <ul class="meta">
              <li><i class="fas fa-id-badge"></i> {{ t.external_id }}</li>
              <li><i class="fas fa-building"></i> {{ t.buyer_name }}</li>
              <li><i class="fas fa-sack-dollar"></i> {{ formatMoney(t.budget_amount) }}</li>
              <li><i class="fas fa-tags"></i> {{ t.main_category }}</li>
              <li><i class="fas fa-users"></i> {{ t.number_of_tenderers }} participantes</li>
              <li><i class="fas fa-clock"></i> {{ t.tender_duration_days }} d√≠as</li>
              <li><i class="fas fa-calendar-plus"></i> Publicada: {{ t.tender_start_date | date:'mediumDate' }}</li>
              <li><i class="fas fa-calendar-check"></i> Cierra: {{ t.tender_end_date | date:'mediumDate' }}</li>
            </ul>
            <footer class="card__footer">
              <button class="btn primary">Ver detalle</button>
              <button class="btn" (click)="getAIRecommendation(t)" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <i class="fas fa-robot"></i> Recomendaci√≥n IA
              </button>
            </footer>
          </article>
        </div>
        <ng-template #emptyOpen>
          <div class="empty">Sin licitaciones abiertas para los filtros.</div>
        </ng-template>
      </div>

      <div class="results__group">
        <h2>Cerradas <span class="count">{{ closedResults.length }}</span></h2>
        <div class="cards" *ngIf="closedResults.length; else emptyClosed">
          <article class="card card--closed" *ngFor="let t of closedResults">
            <header class="card__header">
              <span class="badge badge--closed">Cerrada</span>
              <h3 class="card__title">{{ t.title }}</h3>
            </header>
            <ul class="meta">
              <li><i class="fas fa-id-badge"></i> {{ t.external_id }}</li>
              <li><i class="fas fa-building"></i> {{ t.buyer_name }}</li>
              <li><i class="fas fa-sack-dollar"></i> {{ formatMoney(t.budget_amount) }}</li>
              <li><i class="fas fa-tags"></i> {{ t.main_category }}</li>
              <li><i class="fas fa-users"></i> {{ t.number_of_tenderers }} participantes</li>
              <li><i class="fas fa-clock"></i> {{ t.tender_duration_days }} d√≠as</li>
              <li><i class="fas fa-calendar-plus"></i> Publicada: {{ t.tender_start_date | date:'mediumDate' }}</li>
            </ul>
            <footer class="card__footer">
              <button class="btn">Ver detalle</button>
              <button class="btn" (click)="getAIRecommendation(t)" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <i class="fas fa-robot"></i> Recomendaci√≥n IA
              </button>
            </footer>
          </article>
        </div>
        <ng-template #emptyClosed>
          <div class="empty">Sin licitaciones cerradas para los filtros.</div>
        </ng-template>
      </div>
    </section>
  </main>
</div>

<!-- Modal de Recomendaci√≥n IA -->
<div class="modal-overlay" *ngIf="showAIModal" (click)="closeAIModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <header class="modal-header">
      <h2><i class="fas fa-robot"></i> Recomendaci√≥n IA</h2>
      <button class="btn-close" (click)="closeAIModal()" aria-label="Cerrar">
        <i class="fas fa-times"></i>
      </button>
    </header>

    <div class="modal-body" *ngIf="selectedTender">
      <!-- Informaci√≥n de la licitaci√≥n -->
      <section class="tender-info">
        <h3>{{ selectedTender.title }}</h3>
        <div class="info-grid">
          <div class="info-item">
            <i class="fas fa-building"></i>
            <span>{{ selectedTender.buyer_name }}</span>
          </div>
          <div class="info-item">
            <i class="fas fa-sack-dollar"></i>
            <span>Presupuesto: {{ formatMoney(selectedTender.budget_amount) }}</span>
          </div>
          <div class="info-item">
            <i class="fas fa-users"></i>
            <span>{{ selectedTender.number_of_tenderers }} participantes</span>
          </div>
          <div class="info-item">
            <i class="fas fa-tags"></i>
            <span>{{ selectedTender.main_category }}</span>
          </div>
        </div>
      </section>

      <!-- Formulario de oferta -->
      <section class="bid-form" *ngIf="!predictionResult">
        <h4>Ingresa los datos de tu oferta</h4>
        <div class="form-group">
          <label for="bidAmount">Monto de oferta (USD)</label>
          <div class="input-with-currency">
            <span class="currency-symbol">$</span>
            <input 
              type="text" 
              id="bidAmount" 
              [(ngModel)]="valorCrudo"
              (blur)="formatearMonto()"
              (keydown.enter)="formatearMonto()"
              placeholder="Escribe el monto"
              class="form-control with-currency"
              autocomplete="off"
            />
          </div>
          <small class="form-hint">
            Presupuesto referencial: {{ formatMoney(selectedTender.budget_amount) }}
          </small>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="contractStart">Fecha inicio contrato</label>
            <input 
              type="date" 
              id="contractStart" 
              [(ngModel)]="contractStartDate"
              class="form-control"
            />
          </div>
          <div class="form-group">
            <label for="contractEnd">Fecha fin contrato</label>
            <input 
              type="date" 
              id="contractEnd" 
              [(ngModel)]="contractEndDate"
              class="form-control"
            />
          </div>
        </div>

        <button 
          class="btn btn-ai btn-large" 
          (click)="requestPrediction()"
          [disabled]="isLoadingPrediction || bidAmount <= 0"
          *ngIf="!isLoadingPrediction"
        >
          <i class="fas fa-magic"></i>
          Obtener Recomendaci√≥n IA
        </button>

        <!-- Barra de carga con porcentaje -->
        <div class="loading-section" *ngIf="isLoadingPrediction">
          <div class="loading-header">
            <i class="fas fa-spinner fa-spin"></i>
            <span class="loading-text">{{ loadingMessage }}</span>
            <span class="loading-percentage">{{ loadingProgress.toFixed(0) }}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="loadingProgress"></div>
          </div>
          <button 
            class="btn btn-secondary btn-large mt-1" 
            (click)="cancelPrediction()"
          >
            <i class="fas fa-times"></i>
            Cancelar (No consumir cr√©ditos)
          </button>
        </div>
      </section>

      <!-- Resultados de la predicci√≥n -->
      <section class="prediction-result" *ngIf="predictionResult">
        <!-- Encabezado con badge de IA -->
        <div class="prediction-header">
          <div class="header-left">
            <i class="fas fa-robot"></i>
            <div>
              <h3>An√°lisis Predictivo Completado</h3>
            </div>
          </div>
          <span class="ai-badge-result">
            <i class="fas fa-check-circle"></i>
            Resultado IA
          </span>
        </div>

        <!-- Tarjeta de probabilidad con animaci√≥n -->
        <div class="probability-card-modern" 
             [class.high]="predictionResult.probability >= 0.7" 
             [class.medium]="predictionResult.probability >= 0.5 && predictionResult.probability < 0.7" 
             [class.low]="predictionResult.probability < 0.5">
          <div class="probability-icon-modern">
            <i class="fas fa-chart-line" *ngIf="predictionResult.probability >= 0.7"></i>
            <i class="fas fa-chart-bar" *ngIf="predictionResult.probability >= 0.5 && predictionResult.probability < 0.7"></i>
            <i class="fas fa-exclamation-triangle" *ngIf="predictionResult.probability < 0.5"></i>
          </div>
          <div class="probability-content">
            <h4>Probabilidad de Ganar</h4>
            <div class="probability-value-modern">{{ (predictionResult.probability * 100).toFixed(1) }}%</div>
            <div class="probability-bar">
              <div class="probability-fill" [style.width.%]="predictionResult.probability * 100"></div>
            </div>
            <p class="probability-status">
              <span *ngIf="predictionResult.probability >= 0.7">üéØ Alta probabilidad de √©xito</span>
              <span *ngIf="predictionResult.probability >= 0.5 && predictionResult.probability < 0.7">‚úì Probabilidad favorable</span>
              <span *ngIf="predictionResult.probability < 0.5">‚ö†Ô∏è Baja probabilidad - Considerar ajustar oferta</span>
            </p>
          </div>
        </div>

        <!-- Tarjeta de recomendaci√≥n con estilo mejorado -->
        <div class="recommendation-card-modern">
          <div class="recommendation-icon">
            <i class="fas fa-lightbulb"></i>
          </div>
          <div class="recommendation-content">
            <h4>Recomendaci√≥n Inteligente</h4>
            <div class="recommendation-text-modern">{{ predictionResult.recommendation }}</div>
          </div>
        </div>

        <!-- Botones de acci√≥n mejorados -->
        <div class="action-buttons-modern">
          <button class="btn btn-outline" (click)="predictionResult = null">
            <i class="fas fa-arrow-left"></i> 
            Modificar Oferta
          </button>
          <button class="btn btn-success-modern">
            <i class="fas fa-paper-plane"></i> 
            Confirmar Participaci√≥n
          </button>
        </div>
      </section>
    </div>
  </div>
</div>
